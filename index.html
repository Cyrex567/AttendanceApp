<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Café | Live Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-attendee {
            animation: fadeIn 0.5s ease-out;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 transform transition-all">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800">Study Café Attendance</h1>
            <p class="text-slate-500 mt-2">Sign in to let us know you're here!</p>
        </div>

        <form id="attendanceForm" class="space-y-4">
            <div>
                <label for="nameInput" class="text-sm font-medium text-slate-600">Full Name</label>
                <input type="text" id="nameInput" placeholder="e.g., Ada Lovelace" required class="mt-1 block w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            </div>
            <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300 transform active:scale-95 shadow-lg hover:shadow-indigo-300 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:shadow-none">
                Sign In
            </button>
        </form>
        
        <div class="mt-8">
            <div class="flex justify-between items-center border-b border-slate-200 pb-2">
                <h2 class="text-xl font-semibold text-slate-800">Attendees</h2>
                <span id="attendeeCount" class="text-lg font-bold bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">0</span>
            </div>
            <ul id="attendanceList" class="mt-4 space-y-3 h-64 overflow-y-auto custom-scrollbar pr-2">
                <li id="loadingState" class="text-center text-slate-400 py-4">Connecting to the session...</li>
            </ul>
        </div>
         <div class="text-center mt-8 pt-4 border-t border-slate-200">
            <p class="text-xs text-slate-400">Crafted by Gergő Morvai</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import statements must be at the top-level of a module.
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This ensures the rest of the script runs only after the page is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            
            // Your web app's Firebase configuration
            const firebaseConfig = {
              //apiKey: "AIzaSyA8XE9vef9xMJEgl7pcplEgc2OaM2xefW0",
              authDomain: "attendance-30747.firebaseapp.com",
              databaseURL: "https://attendance-30747-default-rtdb.europe-west1.firebasedatabase.app",
              projectId: "attendance-30747",
              storageBucket: "attendance-30747.appspot.com",
              messagingSenderId: "1018245934140",
              appId: "1:1018245934140:web:3c0bbb0652ec50345c6739",
              measurementId: "G-1RC6B3LR8W"
            };
            
            const appId = firebaseConfig.projectId;
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const attendanceForm = document.getElementById('attendanceForm');
            const nameInput = document.getElementById('nameInput');
            const submitBtn = document.getElementById('submitBtn');
            const attendanceList = document.getElementById('attendanceList');
            const attendeeCount = document.getElementById('attendeeCount');
            const loadingState = document.getElementById('loadingState');

            let currentUserId = null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User is authenticated with UID:", user.uid);
                    currentUserId = user.uid;
                    listenForAttendees();
                } else {
                    console.log("No user is signed in. Attempting anonymous sign-in...");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        alert("Could not connect to the session. Please refresh the page.");
                    }
                }
            });

            const attendanceCollectionRef = collection(db, `/artifacts/${appId}/public/data/attendance`);

            function listenForAttendees() {
                const q = query(attendanceCollectionRef, orderBy("timestamp", "desc"));
                
                onSnapshot(q, (snapshot) => {
                    const attendees = [];
                    snapshot.forEach((doc) => {
                        attendees.push({ id: doc.id, ...doc.data() });
                    });
                    renderAttendees(attendees);
                }, (error) => {
                    console.error("Error fetching attendees:", error);
                    if(loadingState) loadingState.textContent = "Error loading list.";
                });
            }

            function renderAttendees(attendees) {
                if (!attendanceList || !attendeeCount) return;
                
                attendanceList.innerHTML = '';
                
                if (attendees.length === 0) {
                     attendanceList.innerHTML = '<li class="text-center text-slate-400 py-4">No one has signed in yet. Be the first!</li>';
                } else {
                    attendees.forEach((attendee, index) => {
                        const li = document.createElement('li');
                        li.className = `bg-slate-50 p-3 rounded-lg flex items-center justify-between ${index === 0 ? 'new-attendee' : ''}`;
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.textContent = attendee.name;
                        nameSpan.className = 'text-slate-700 font-medium';
                        
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'text-xs text-slate-400';
                        if (attendee.timestamp && attendee.timestamp.toDate) {
                            timeSpan.textContent = attendee.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        }
                        
                        li.appendChild(nameSpan);
                        li.appendChild(timeSpan);
                        attendanceList.appendChild(li);
                    });
                }
                attendeeCount.textContent = attendees.length;
            }

            if (attendanceForm) {
                attendanceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!currentUserId) {
                        alert("You are not authenticated. Please wait a moment and try again.");
                        return;
                    }
                    
                    const name = nameInput.value.trim();
                    if (name === '') {
                        alert("Please enter your name.");
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    
                    try {
                        await addDoc(attendanceCollectionRef, {
                            name: name,
                            timestamp: serverTimestamp(),
                            submittedBy: currentUserId
                        });
                        nameInput.value = '';
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        alert("There was an error submitting your name. Please try again.");
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Sign In';
                    }
                });
            }
        });
    </script>

</body>
</html>


